# 条文くん (Joubun-kun) 開発メモ

## 重要な注意事項

### データソースの優先順位

| ソース | 内容 | 用途 |
|--------|------|------|
| `r2_backup_20251226/` | R2データのバックアップ（2025-12-26時点） | **信頼できるソース** |
| `r2_backup_20260117/` | R2データのバックアップ（2026-01-17時点） | **最新バックアップ** |
| `output_v2/` | 古いローカルデータ（2025-12-16時点） | **使用禁止** |

**重要**: マッピングやデータ更新時は必ず `r2_backup_*` を参照すること。`output_v2` は古いデータなので使用しない。

### R2データ更新時の注意

1. **マッピングを更新する際は必ず`r2_backup_20251226`以降のバックアップを参照する**
2. **`output_v2`のマッピング関連ファイルは信頼しない**
3. **R2データを更新したら`law_chunk_map.json`も同期する**

---

## アーキテクチャ概要

### 処理フロー

```
1. クエリ分類・マルチクエリ生成
2. Vectorize検索（Top20取得）
3. 【Claude 1回目】条文選定（5件程度）
4. refs/reverse_refs 取得（R2 refs_chunks形式）
5. 参照先条文の内容取得（R2）
6. 【Claude 2回目】説明文生成（選定条文 + 参照条文情報込み）
7. 説明文から言及条文を抽出（正規表現）
8. 言及条文をVectorize検索で取得
9. 言及条文のみサイドバーに表示
```

### データ構成

```
R2 (joubun-kun-data):
├── law_chunk_map.json              # 法令ID → チャンク番号マップ（8,910件）
├── laws_chunk_XXX_light.json       # 法令データチャンク（約300個）
├── large_law_articles_v2/          # 大規模法令の条文単位ファイル
│   ├── 332AC0000000026/            # 租税特別措置法
│   ├── 129AC0000000089/            # 民法
│   ├── 417AC0000000086/            # 会社法
│   └── ...                         # 計14法令
└── refs_chunks/                    # 参照条文データ
    ├── refs_index.json             # 法令ID → チャンク番号
    └── refs_chunk_XXX.json         # 25チャンク

Vectorize (law-embeddings):
- 約50万件の条文ベクトル
- メタデータ: law_id, law_title, article_title, caption
```

### 大規模法令の特別処理

以下の法令はWorkerにハードコードされた処理がある:

- **会社法**: `KAISHAHO_RANGES` でチャンク76, 100-105に分散
- **民法**: `MINPO_RANGES` でチャンク63, 106に分散
- **租税特別措置法ファミリー**: `LARGE_075` マーカーで条文単位ファイルから取得

---

## 開発履歴

### 2025-12-22: 租税特別措置法対応

- R2の`laws_chunk_075_light.json`が空ファイルだった問題を解決
- 条文単位ファイル（v2形式）を生成: `large_law_articles_v2/{law_id}/{article_title}.json`
- 同名条文（本則と附則）を`articles`配列で管理

### 2025-12-23: chunk 075 大規模法令対応

- 70MB超のchunk 075を65個のサブチャンクに分割
- 14個の大規模法令を条文単位ファイル（v2形式）に移行
- `COMMON_LAW_IDS`によるlaw_id修正ロジック追加

### 2025-12-24: 参照条文機能（refs/reverse_refs）

- `/api/refs`エンドポイント追加
- `/api/articles`エンドポイント追加
- 2段階Claude呼び出し（条文選定→説明生成）に変更
- 言及条文抽出機能追加

### 2025-12-26: refs_chunks形式・全法令IDマッピング

- refs を5,679個→25チャンク+インデックスに再構成
- `src/lawIds.js`新規作成（8,878件の法令マッピング）
- R2データバックアップ: `r2_backup_20251226/`
- sub_items（イ、ロ、ハ等）対応
- Observabilityログ機能追加

### 2025-12-30: 正規表現修正

- 「法律」で終わる法令名（電子署名及び認証業務に関する法律等）に対応
- 正規表現パターンを`(法律|法|令|規則|規程)`に拡張

### 2026-01-17: マッピング修正・UI改善

#### law_chunk_map 全面修正

**問題**: 会社計算規則が検索できない（`paragraphs: 0`）

**根本原因**:
- `law_chunk_map.json`は`output_v2`（12/16）を基に生成されていた
- R2データは12/26以降更新されたが、マップは未更新
- 8,908件中ほぼ全件が不正確だった

**解決策**:
- `r2_backup_20251226`から正しいマッピングを生成
- R2の`law_chunk_map.json`を上書き

#### UI改善

- 検索履歴エリアをスクロール可能に変更
- AI解説省略トグルを入力窓のすぐ上に配置（トップページ時のみ）
- 不要な境界線を削除

#### R2バックアップ

- `r2_backup_20260117/`に最新状態をバックアップ

---

## コスト分析

### 1回の検索あたりのトークン使用量（実測値）

| 呼び出し | 入力 | 出力 | 用途 |
|---------|------|------|------|
| /api/classify | 350-770 | 60-70 | クエリ分類 |
| /api/chat (1回目) | 4,000-7,000 | 17-23 | 条文選定 |
| /api/chat (2回目) | 1,700-2,900 | 400-640 | 説明文生成 |
| **合計** | **約7,000-10,000** | **約500-700** | |

### コスト計算（Claude Sonnet 4.5）

- 入力: $3 / 100万トークン
- 出力: $15 / 100万トークン
- **1回の検索: 約4-6円**
- 月1,000回: 約5,000円

---

## デプロイ情報

- **フロントエンド**: https://joubun-kun.pages.dev
- **Worker API**: https://morning-surf-f117.ikeda-250.workers.dev

---

## 主要スクリプト

| スクリプト | 用途 |
|-----------|------|
| `scripts/check_all_mapping.cjs` | r2_backupとlaw_chunk_mapの全件比較 |
| `scripts/upgrade_all_chunks.py` | 全チャンクのsub_items再抽出 |
| `scripts/upload_upgraded_to_r2.cjs` | アップグレード済みファイルのR2アップロード |
| `scripts/split_refs_by_size.cjs` | refs を1MBチャンクに分割 |
| `scripts/upload_refs_chunks.cjs` | refs_chunks を R2 にアップロード |
| `scripts/generate_large_law_articles.py` | 大規模法令の条文単位ファイル生成 |

---

## ローカルディレクトリ

| ディレクトリ | 内容 |
|-------------|------|
| `r2_backup_20251226/` | R2データのバックアップ（信頼できるソース） |
| `r2_backup_20260117/` | R2データの最新バックアップ |
| `r2_subitems_fixed/` | sub_items追加版 |
| `output_v2/` | **使用禁止**（古いデータ） |
| `refs_chunks/` | 参照条文チャンク |
